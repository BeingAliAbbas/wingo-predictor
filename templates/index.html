<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ali Abbas - Wingo 30S Predictor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#232946"/>
  <style>
    body {
      background: linear-gradient(135deg, #232946 0%, #1e1b4b 100%);
      min-height: 100vh;
    }
    .glass {
      background: rgba(35, 41, 70, 0.90);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25);
      border-radius: 1.5rem;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
    }
    .neumorph {
      box-shadow:
        2px 2px 8px #1e1b4b,
        -2px -2px 8px #262c4a;
      border-radius: 1.25rem;
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .glow-container {
      background: #191919;
      border-radius: 18px;
      box-shadow:  0 0 0 1.5px #14b8a6;
      margin-bottom: 18px;
      padding: 16px 20px 10px 18px;
      position: relative;
      opacity: 0;
      transform: translateY(15px);
      transition: opacity 0.5s, transform 0.5s;
    }
    .glow-container.show {
      opacity: 1;
      transform: translateY(0);
    }
    .glow-container.win {
      box-shadow: 0 0 0 1.5px #22c55e;
    }
    .glow-container.loss {
      box-shadow: 0 0 0 1.5px #ef4444;
    }
    .glow-success {
      color: #22ff22;
      font-size: 1.5rem;
      margin-right: 6px;
      vertical-align: middle;
    }
    .glow-fail {
      color: #ff2222;
      font-size: 1.5rem;
      margin-right: 6px;
      vertical-align: middle;
    }
    .glow-info { color: #06f1f7; }
    .glow-label {
      font-weight: 700;
      font-size: 1.09rem;
      letter-spacing: 0.01em;
    }
    .stage-label {
      font-size: 0.97em;
      font-weight: 600;
      margin-left: 10px;
      color: #ffd93a;
    }
    .glow-row {
      display: flex;
      align-items: center;
      margin-bottom: 7px;
      gap: 8px;
      font-size: 1rem;
    }
    .glow-icon {
      margin-right: 9px;
      font-size: 1.2rem;
      vertical-align: middle;
    }
    .glow-right {
      position: absolute;
      top: 16px;
      right: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .glow-trophy {
      color: #20e720;
      font-size: 1.6rem;
      filter: drop-shadow(0 0 2px #13ef13cc);
    }
    .glow-x {
      color: #ff4444;
      font-size: 1.5rem;
      filter: drop-shadow(0 0 2px #e81c1cbb);
    }
    /* Smooth prediction card transitions */
    .prediction-fade {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 0.5s, transform 0.5s;
    }
    .prediction-fade.show {
      opacity: 1;
      transform: scale(1);
    }
    .confidence-bar {
      height: 8px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 6px;
    }
    .confidence-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s, background 0.3s;
    }
    .confidence-fill.high {
      background: linear-gradient(90deg, #22c55e, #16a34a);
    }
    .confidence-fill.medium {
      background: linear-gradient(90deg, #eab308, #ca8a04);
    }
    .confidence-fill.low {
      background: linear-gradient(90deg, #6366f1, #4f46e5);
    }
    .strategy-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin: 2px;
      background: rgba(99, 102, 241, 0.2);
      border: 1px solid rgba(99, 102, 241, 0.3);
    }
    .strategy-badge.big { 
      background: rgba(236, 72, 153, 0.2); 
      border-color: rgba(236, 72, 153, 0.4);
      color: #f472b6;
    }
    .strategy-badge.small { 
      background: rgba(34, 197, 94, 0.2); 
      border-color: rgba(34, 197, 94, 0.4);
      color: #4ade80;
    }
    .ml-badge {
      background: linear-gradient(90deg, #8b5cf6, #6366f1);
      color: white;
      padding: 2px 8px;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    @media (max-width: 640px) {
      .glass { padding: 0.5rem !important; }
      .glow-container { padding: 8px 7px 7px 8px; }
      .glow-right { right: 9px; top: 8px; }
    }
  </style>
</head>
<body class="text-neutral-100">
  <main class="flex flex-col min-h-screen justify-center items-center px-1 sm:px-2 bg-gradient-to-br from-[#232946] to-[#1e1b4b]">
    <section class="w-full max-w-2xl glass px-2 sm:px-7 py-3 sm:py-7 mt-3 sm:mt-6 neumorph">
      <!-- Header -->
      <header class="flex flex-col items-center mb-5 sm:mb-6">
        <span class="text-3xl sm:text-4xl font-extrabold tracking-tight text-indigo-400 drop-shadow-sm flex items-center">
          <svg class="inline w-8 h-8 sm:w-10 sm:h-10 mr-1 sm:mr-2 -mt-1 sm:-mt-2" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#6366f1"/><text x="50%" y="56%" text-anchor="middle" fill="#fff" font-size="10" font-family="Arial" dy=".3em">üîÆ</text></svg>
          WinGo 30S Predictor
        </span>
        <span class="text-xs sm:text-base text-neutral-300 mt-1 sm:mt-2 text-center">Predicting the future, every 30 seconds</span>
        <div class="flex items-center gap-2 mt-2">
          <span class="ml-badge">üß† ML-Powered</span>
          <span class="text-xs text-green-400">üêç Python Backend ‚Ä¢ üìä JSON Storage</span>
        </div>
      </header>

      <!-- Data Stats -->
      <div id="dataStats" class="flex flex-wrap items-center justify-center gap-3 mb-4 text-xs text-neutral-400">
        <span>üìä Records: <span id="historicalCount" class="text-indigo-300 font-bold">--</span></span>
        <span>üìà Big/Small: <span id="distribution" class="text-indigo-300 font-bold">--</span></span>
        <span>üéØ Model Accuracy: <span id="modelAccuracy" class="text-green-400 font-bold">--</span></span>
      </div>

      <!-- Prediction & Dashboard Area -->
      <div id="predictionDashboardArea" class="flex flex-col gap-6 mb-8">
        <!-- Dashboard -->
        <div id="dashboard" class="flex flex-row items-center justify-between bg-neutral-900/80 glass neumorph rounded-xl p-4 gap-3 text-center">
          <div>
            <div class="text-xs text-neutral-400 mb-1">Wins</div>
            <div id="wins" class="text-2xl font-bold text-green-400">0</div>
          </div>
          <div>
            <div class="text-xs text-neutral-400 mb-1">Losses</div>
            <div id="losses" class="text-2xl font-bold text-red-400">0</div>
          </div>
          <div>
            <div class="text-xs text-neutral-400 mb-1">Accuracy</div>
            <div id="accuracy" class="text-2xl font-bold text-blue-300">--</div>
          </div>
          <div>
            <div class="text-xs text-neutral-400 mb-1">Total Games</div>
            <div id="total" class="text-2xl font-bold text-indigo-300">0</div>
          </div>
          <div>
            <div class="text-xs text-neutral-400 mb-1">Max Loss Streak</div>
            <div id="maxLossStreak" class="text-2xl font-bold text-yellow-400">0</div>
          </div>
        </div>
  
        <!-- Prediction Card -->
        <div id="predictionCardGroup" class="grid grid-cols-1 sm:grid-cols-3 gap-3 sm:gap-4 mb-0 prediction-fade show">
          <div class="flex flex-col justify-center items-center bg-neutral-800/80 neumorph px-3 py-3 sm:px-5 sm:py-4 rounded-xl shadow">
            <span class="text-xs sm:text-sm text-neutral-400 tracking-wide">Next Period</span>
            <span id="nextPeriod" class="text-xl sm:text-2xl font-mono font-bold mt-1 break-all">Loading</span>
          </div>
          <div class="flex flex-col justify-center items-center bg-neutral-800/80 neumorph px-3 py-3 sm:px-5 sm:py-4 rounded-xl shadow">
            <span class="text-xs sm:text-sm text-neutral-400 tracking-wide">üéØ Prediction</span>
            <span id="nextPrediction" class="text-2xl sm:text-3xl font-bold mt-1 transition-all">Loading</span>
            <div class="confidence-bar w-full mt-2">
              <div id="confidenceFill" class="confidence-fill low" style="width: 50%"></div>
            </div>
            <span id="confidenceText" class="text-xs text-neutral-400 mt-1">Confidence: --</span>
          </div>
          <div class="flex flex-col justify-center items-center bg-neutral-800/80 neumorph px-3 py-3 sm:px-5 sm:py-4 rounded-xl shadow">
            <span class="text-xs sm:text-sm text-neutral-400 tracking-wide">‚è±Ô∏è Time Left</span>
            <span id="countdown" class="text-2xl sm:text-3xl font-mono font-bold mt-1">Loading</span>
          </div>
        </div>

        <!-- Strategy Card -->
        <div class="bg-neutral-800/60 neumorph rounded-xl p-4">
          <div class="flex items-center gap-2 mb-3">
            <span class="text-sm font-semibold text-indigo-300">üß† ML Strategy</span>
            <span id="strategyReason" class="text-xs text-neutral-400 italic">Loading...</span>
          </div>
          <div id="strategiesList" class="flex flex-wrap gap-2">
            <!-- Strategies will be rendered here -->
          </div>
        </div>
      </div>

      <!-- Error Panel - Only shown for draw API errors -->
      <div id="errorPanel" class="hidden bg-red-900/80 text-red-200 rounded-lg px-4 py-3 mb-4 sm:mb-6 font-mono text-xs"></div>

      <!-- History Area (separate block below prediction/dashboard) -->
      <div id="historyArea" class="w-full mt-3">
        <div class="flex items-center justify-between mb-3">
          <span class="text-lg font-bold text-indigo-300">üìú Prediction History</span>
          <button id="clearBtn"
            class="bg-red-500/80 hover:bg-red-600 transition px-3 py-1.5 text-sm font-semibold rounded-lg shadow text-white">
            üóëÔ∏è Clear
          </button>
        </div>
        <!-- History - Card/Container Style -->
        <div id="historyList" class="flex flex-col max-h-96 overflow-y-auto scrollbar-hide"></div>
      </div>

      <!-- Credit Card -->
      <div class="flex justify-center mt-8">
        <div class="flex flex-col items-center bg-neutral-900/90 border border-neutral-700 rounded-xl shadow-md px-10 py-5 w-full max-w-2xl">
          <div class="flex items-center gap-2 mb-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <circle cx="12" cy="12" r="10" fill="#6366f1"/>
              <text x="50%" y="56%" text-anchor="middle" fill="#fff" font-size="12" font-family="Arial" dy=".3em">üë®‚Äçüíª</text>
            </svg>
            <span class="text-lg font-semibold text-indigo-200">Made by Ali Abbas</span>
          </div>
          <span class="text-xs text-neutral-400 mb-1">WhatsApp</span>
          <a href="https://wa.me/923483469617" target="_blank" class="text-sm font-mono text-green-400 hover:underline hover:text-green-300 transition">
            +92 348 3469617
          </a>
        </div>
      </div>
    </section>
  </main>

  <script>
const API_BASE = window.location.origin;
let lastPeriod = null;

function showError(msg) {
  const el = document.getElementById('errorPanel');
  if (el) {
    el.textContent = msg;
    el.classList.remove("hidden");
  }
}
function hideError() {
  const el = document.getElementById('errorPanel');
  if (el) el.classList.add("hidden");
}

const pad = n => n < 10 ? '0' + n : n;

function colorClass(lab) {
  if (lab === 'Big') return 'text-pink-400';
  if (lab === 'Small') return 'text-green-400';
  return 'text-neutral-300';
}

function resultIcon(correct) {
  return correct
    ? '<span class="glow-trophy" title="Win">üèÜ</span>'
    : '<span class="glow-x" title="Loss">‚úñÔ∏è</span>';
}

function getOrdinalSuffix(n) {
  const s = ['th', 'st', 'nd', 'rd'];
  const v = n % 100;
  return s[(v - 20) % 10] || s[v] || s[0];
}

function renderDashboard(stats) {
  const winsEl = document.getElementById('wins');
  const lossesEl = document.getElementById('losses');
  const totalEl = document.getElementById('total');
  const accuracyEl = document.getElementById('accuracy');
  const maxLossStreakEl = document.getElementById('maxLossStreak');
  
  if (winsEl) winsEl.textContent = stats.wins || 0;
  if (lossesEl) lossesEl.textContent = stats.losses || 0;
  if (totalEl) totalEl.textContent = stats.total || 0;
  if (accuracyEl) accuracyEl.textContent = stats.accuracy ? stats.accuracy + '%' : '--';
  if (maxLossStreakEl) maxLossStreakEl.textContent = stats.max_loss_streak || 0;
}

function renderStrategies(strategies) {
  const list = document.getElementById('strategiesList');
  if (!list || !strategies) return;
  
  list.innerHTML = strategies.map(s => `
    <span class="strategy-badge ${s.prediction.toLowerCase()}">
      ${s.name}: <strong class="ml-1">${s.prediction}</strong> (${s.confidence}%)
    </span>
  `).join('');
}

// Animate new history cards with fade in
function renderHistory(history) {
  const list = document.getElementById('historyList');
  if (!list) return;
  list.innerHTML = '';
  
  // Filter out predictions that are not resolved yet
  const filtered = history.filter(e => e.actual_number !== null);
  filtered.slice(0, 50).forEach((e, idx) => {
    const div = document.createElement('div');
    const isWin = e.correct === true || e.correct === 1;
    const isLoss = e.correct === false || e.correct === 0;
    div.className = `glow-container ${isWin ? 'win' : ''} ${isLoss ? 'loss' : ''}`;
    
    let stageInfo = '';
    if ((e.correct === true || e.correct === 1) && e.stage > 1) {
      stageInfo = `<span class="stage-label">üéâ WON at ${e.stage}${getOrdinalSuffix(e.stage)} stage</span>`;
    } else if (e.correct === false || e.correct === 0) {
      stageInfo = `<span class="stage-label">üìç Stage ${e.stage}</span>`;
    }
    
    div.innerHTML = `
      <div class="glow-row">
        <span class="glow-icon">üìÖ</span>
        <span class="glow-info">Period: <span class="glow-label">${e.period}</span></span>
      </div>
      <div class="glow-row">
        <span class="glow-icon">üìù</span>
        <span class="glow-info">Prediction: <span class="glow-label ${colorClass(e.prediction)}">${e.prediction}</span>
          <span class="text-xs text-neutral-500 ml-2">(${e.confidence || '--'}%)</span>
        </span>
      </div>
      <div class="glow-row">
        <span class="glow-icon">üé≤</span>
        <span class="glow-info">Result: <span class="glow-label ${colorClass(e.actual_label)}">${e.actual_label} <span style="font-weight: 400;">(${e.actual_number})</span></span></span>
        ${stageInfo}
      </div>
      ${e.reason ? `<div class="glow-row text-xs text-neutral-500"><span class="glow-icon">üß†</span>${e.reason}</div>` : ''}
      <div class="glow-right">
        ${e.correct !== null ? resultIcon(e.correct) : ''}
      </div>
    `;
    list.appendChild(div);
    // Animate fade in
    setTimeout(() => div.classList.add('show'), 30 * idx);
  });
}

// -- TIMER LOGIC --
let countdownIv = null;
function startCountdown(seconds = 30) {
  if (countdownIv) clearInterval(countdownIv);
  let cnt = seconds;
  const el = document.getElementById('countdown');
  function update() {
    if (!el) return;
    let min = Math.floor(cnt / 60);
    let sec = cnt % 60;
    el.textContent = `${pad(min)}:${pad(sec)}`;
    if (cnt <= 0) {
      clearInterval(countdownIv);
      el.textContent = "00:00";
    }
    cnt--;
  }
  update();
  countdownIv = setInterval(update, 1000);
}

// Animate prediction card area on change
function animatePredictionCard() {
  const card = document.getElementById('predictionCardGroup');
  if (!card) return;
  card.classList.remove('show');
  // Force reflow for restart animation
  void card.offsetWidth;
  setTimeout(() => card.classList.add('show'), 20);
}

let prevPeriod = null;
let lastPeriodForTimer = null;

async function tick(force = false) {
  try {
    const response = await fetch(`${API_BASE}/api/predict?ts=${Date.now()}`);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    const data = await response.json();
    
    if (data.error) {
      showError(data.error);
      return;
    }
    
    hideError();
    
    // Reset timer if period changes (or first time)
    if (lastPeriodForTimer !== data.latest_period) {
      startCountdown(30);
      lastPeriodForTimer = data.latest_period;
    }
    
    // Update data stats
    const historicalCountEl = document.getElementById('historicalCount');
    const distributionEl = document.getElementById('distribution');
    const modelAccuracyEl = document.getElementById('modelAccuracy');
    if (historicalCountEl) historicalCountEl.textContent = data.analysis?.total_historical_records || '--';
    if (distributionEl) {
      const bigPct = data.analysis?.big_percentage || 50;
      const smallPct = data.analysis?.small_percentage || 50;
      distributionEl.textContent = `${bigPct}% / ${smallPct}%`;
    }
    if (modelAccuracyEl) modelAccuracyEl.textContent = (data.analysis?.model_accuracy || 0) + '%';
    
    // Animate prediction card only if period changes
    if (prevPeriod !== data.next_period) {
      animatePredictionCard();
      prevPeriod = data.next_period;
    }
    
    // Update UI
    const nextPeriodEl = document.getElementById('nextPeriod');
    if (nextPeriodEl) nextPeriodEl.textContent = data.next_period;
    
    const np = document.getElementById('nextPrediction');
    if (np) {
      np.textContent = data.prediction;
      np.className = colorClass(data.prediction) + ' text-2xl sm:text-3xl font-bold mt-1 transition-all';
    }
    
    // Update confidence with color coding
    const confidenceFill = document.getElementById('confidenceFill');
    const confidenceText = document.getElementById('confidenceText');
    if (confidenceFill) {
      confidenceFill.style.width = `${data.confidence}%`;
      confidenceFill.className = 'confidence-fill ' + 
        (data.confidence >= 60 ? 'high' : data.confidence >= 55 ? 'medium' : 'low');
    }
    if (confidenceText) confidenceText.textContent = `Confidence: ${data.confidence}%`;
    
    // Update strategy reason and list
    const strategyReason = document.getElementById('strategyReason');
    if (strategyReason) strategyReason.textContent = data.reason || '--';
    renderStrategies(data.strategies || []);
    
    // Render dashboard and history
    renderDashboard(data.stats);
    renderHistory(data.stats.history || []);
    
    lastPeriod = data.latest_period;
    
  } catch (err) {
    showError("Update error: " + err.message);
    const countdownEl = document.getElementById('countdown');
    if (countdownEl) countdownEl.textContent = "Error";
  }
}

// Poll for updates
async function startPolling() {
  await tick(true);
  setInterval(() => tick(), 5000); // Poll every 5 seconds
}

const clearBtn = document.getElementById('clearBtn');
if (clearBtn) {
  clearBtn.addEventListener('click', async () => {
    if (window.confirm("Clear all prediction history? (Learned patterns will be kept)")) {
      try {
        await fetch(`${API_BASE}/api/clear`, { method: 'POST' });
        tick(true);
      } catch (err) {
        showError("Error clearing history: " + err.message);
      }
    }
  });
}

startPolling();
  </script>
</body>
</html>
